<h1>Custom Chef Recipes</h1>

<h2>Setup Chef Environment</h2>

<p>In order to be able to develop chef recipes that build (and rebuild each time you start an instance) dependencies of your application, you need to install a few gems and set up API credentials for your AppCloud account.</p>

<h3>Install The Engineyard Gem</h3>

<p>First install the engineyard gem.</p>

<pre><code>$ sudo gem install engineyard
</code></pre>

<h2>Clone ey-cloud-recipes Repository</h2>

<p>Fork and clone the <a href="http://github.com/engineyard/ey-cloud-recipes">ey-cloud-recipes</a> repository.</p>

<ul><li>Browse to the <a href="http://github.com/engineyard/ey-cloud-recipes">ey-cloud-recipes</a> site on GitHub.</li>
<li>Click on the <strong>Fork</strong> button to "Fork" the repository.</li>
<li>This creates a fork under your user account on GitHub.</li>
<li>Click on the <strong>clipboard icon</strong> to copy the URL of your forked repository to your clipboard.</li>
<li><p>Clone the repository to your local development machine. Be sure you do <strong>not</strong> put this inside of your app repository as nested repositories aren't supported in git.</p>

<p>git clone git@github.com:/ey-cloud-recipes.git</p></li>
</ul><p>This local copy of your <strong>ey-cloud-recipes</strong> repository will be the folder you work in when writing custom recipes for your environment.</p>

<h2>File Structure of ey-cloud-recipes</h2>

<h3>Base Files and Folders</h3>

<p>  README.md
  Rakefile
  cookbooks/</p>

<pre><code>main/
  attributes/
  definitions/
  libraries/
  recipes/
</code></pre>

<p>These folders and files were original to the <strong>ey-cloud-recipes</strong> repository before any other cookbooks were added.</p>

<h3>The Cookbooks</h3>

<p>Under <code>cookbooks/</code> you will see a folder for each of the self-contained recipes for various components you can choose to enable.</p>

<p>Each folder under a cookbook has a number of sub-folders.  For this example the sphinx recipe is used:</p>

<p>  cookbooks/sphinx/</p>

<pre><code>files/
  default/
    sphinx.logrotate
recipes/
  default.rb
templates/
  sphinx.monitrc.erb
  sphinx.yml.erb
</code></pre>

<h4>Recipes Folder</h4>

<p>For each cookbook the <code>recipes/default.rb</code> is the main definition file that will prescribe how chef will perform each of its actions to achieve the goal.  View the <a href="http://github.com/engineyard/ey-cloud-recipes/blob/master/cookbooks/sphinx/recipes/default.rb">sphinx example</a>.</p>

<h4>Files Folder</h4>

<p>In the sphinx cookbook the <code>recipes/default.rb</code> creates a <code>remote_file</code> <em>resource</em> (that's a chef term).  And that <em>resource</em> is found in the <code>files/default/sphinx.logrotate</code> location.  Which corresponds to the <em>source</em> value in the code block below.</p>

<p><code>
remote_file "/etc/logrotate.d/sphinx" do
  owner "root"
  group "root"
  mode 0755
  source "sphinx.logrotate"
  backup false
  action :create
end
</code></p>

<p>Why have a flat file?  Well the <code>sphinx.logrotate</code> is a file that has no variables.  That's what the <em>templates</em> are for and that's what you can use standard ERB to inject variable data.</p>

<h4>Templates Folder</h4>

<p>Once again in the <code>recipes/default.rb</code> of the sphinx cookbook a <em>resource</em> is created.  This time it is passing variables to a template.</p>

<p><code>
template "/etc/monit.d/sphinx.#{app_name}.monitrc" do
  source "sphinx.monitrc.erb"
  owner node[:owner_name]
  group node[:owner_name]
  mode 0644
  variables({</code></p>

<pre><code>:app_name =&gt; app_name,
:user =&gt; node[:owner_name],
:flavor =&gt; flavor
</code></pre>

<p>  })
end
</p>

<p>The variables above are passed to the template below and then chef renders the static file defined in the template resource, i.e <code>/etc/monit.d/sphinx.myapp.monitrc</code>.</p>

<p><code>
check process sphinx<em>&lt;%= @app_name %&gt;</em>3312
  with pidfile /var/run/sphinx/&lt;%= @app_name %&gt;.pid
  start program = "/engineyard/bin/&lt;%= @flavor %&gt;<em>searchd &lt;%= @app_name %&gt; start" as uid &lt;%= @user %&gt; and gid &lt;%= @user %&gt;
  stop program = "/engineyard/bin/&lt;%= @flavor %&gt;</em>searchd &lt;%= @app_name %&gt; stop" as uid &lt;%= @user %&gt; and gid &lt;%= @user %&gt;
  group sphinx_&lt;%= @app_name %&gt;
</code></p>

<h2>Turn on a Cookbook</h2>

<p>Please browse the <a href="http://github.com/engineyard/ey-cloud-recipes/tree/master/cookbooks">available cookbooks</a> to see the latest versions.</p>

<p>In order to turn on a cookbook and have that set of recipes run when you deploy your application you need to open the <code>cookbooks/main/recipes/default.rb</code> file.</p>

<p>This file contains a series of lines commented out that either describe or require a given recipe.  The <code>require_recipe</code> method, followed by a string named after the same cookbook.</p>

<p>You want to run the sphinx recipe?  Uncomment the line:</p>

<p><code>
require_recipe "sphinx"
</code></p>

<p>Save your changes and commit the file to the repository.</p>

<pre><code>$ git commit -am "activated sphinx"
</code></pre>

<h2>Create a Cookbook</h2>

<p>For the purposes of this example, we will be creating a new recipe called <strong>nginx_logrotate</strong>.</p>

<p>Go to your local <strong>ey-cloud-recipes</strong> repository folder.  To generate a new recipe type:</p>

<pre><code>$ rake new_cookbook COOKBOOK=nginx_logrotate
</code></pre>

<p>Edit <strong>cookbooks/nginx_logrotate/recipes/default.rb</strong> adding the following code:</p>

<p><code>
remote_file "/etc/logrotate.d/nginx" do
  owner "root"
  group "root"
  mode 0755
  source "nginx.logrotate"
  backup false
  action :create
end
</code></p>

<p>Create a new nginx logrotate config file. Change the retention of Nginx logs to 60 days (the default is 30) by creating the file <strong>files/default/nginx.logrotate</strong> with the following content:</p>

<p>  /var/log/engineyard/nginx/*.log {</p>

<pre><code>daily
missingok
compress
rotate 60
dateext
notifempty
sharedscripts
extension gz
postrotate
    [ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`
endscript
</code></pre>

<p>  }</p>

<p>Add the following line to the bottom of <strong>cookbook/main/recipes/default.rb</strong> to enable the recipe:</p>

<p><code>
require_recipe "nginx_logrotate"
</code></p>

<p>Test the syntax of your new recipe:</p>

<pre><code>$ rake test
</code></pre>

<p>The final step is to commit your changes to the repository.  Once your changes are committed to HEAD of your local git repository then you are ready to deploy.</p>

<pre><code>$ git add . &amp;&amp; git commit -am "Custom logrotate for nginx"
</code></pre>

<h2>Invoking Custom Chef Recipes</h2>

<p>To run your new recipe set you first need to upload the recipes to your environment.</p>

<p>  From the root of your recipes repository run:</p>

<pre><code>$ ey recipes upload -e &lt;environment name&gt;
</code></pre>

<p>  Then run them with:</p>

<pre><code>$ ey recipes apply -e &lt;environment name&gt;
</code></pre>

<p>  You can also choose to do a full chef run:</p>

<pre><code>$ ey rebuild -e &lt;environment name&gt;
</code></pre>

<p>You can now deploy your app code that depends on customizations that chef has configured for you.</p>

<h2>Report to the Dashboard from Custom Recipes</h2>

<p>You can have messages appear when your custom chef recipes run.</p>

<p>The first part of this is included in the <strong>ey-cloud-recipes</strong> repository.  The second part you can include in the <strong>recipe/default.rb</strong> you create.</p>

<p>This code can be found in the <strong>ey-cloud-recipes</strong> repository under ''cookbooks/main/definitions/ey_cloud_report.rb'':</p>

<p><code>
define :ey_cloud_report do
  execute "reporting for #{params[:name]}" do</code></p>

<pre><code>command "ey-enzyme --report '#{params[:message]}'"
epic_fail true
</code></pre>

<p>  end
end
</p>

<p>Then inside your cookbook in the <strong>recipe/default.rb</strong> file, you can use the code like this example:</p>

<p><code>
ey_cloud_report "nginx" do
  message "custom logrotate for nginx"
end
</code></p>

<p>There are further examples of how the ''ey_cloud_report'' method is used in the <a href="http://github.com/engineyard/ey-cloud-recipes/blob/master/cookbooks/sphinx/recipes/default.rb">sphinx recipe</a>.</p>

<p>Now can see when the custom portions of your chef recipes are running in the dashboard.</p>