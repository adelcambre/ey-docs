<!DOCTYPE HTML>
<html>
  <head>
  
    <title>Engine Yard Docs: Adding Cron Jobs</title>
    <meta name="description" content="Learn why Engine Yard\'s managed Rails hosting, Rails deployment &amp; 24/7/365 live service is the best">
    <meta name="keywords" content="Ruby on Rails Fully-Managed Hosting, Scaling, Scaled, Cluster Slices, Cloud Computing, On-Demand Deployment, Merb, Rubinius, Open-Source Software">
    <meta http-equiv="expires" content="0">

    <!--[if IE]>
	  <script src="/javascripts/html5shiv"></script>
    <![endif]-->
    
	<link rel="stylesheet" href="/css/application.css" type="text/css" charset="utf-8" />
    
    <!--[if IE]>
	  <link rel="stylesheet" href="/css/ie.css" type="text/css" charset="utf-8" />
    <![endif]-->
    
    <!--[if lte IE 7]>
	  <link rel="stylesheet" href="/css/ie7.css" type="text/css" charset="utf-8" />
    <![endif]-->

    <script src="http://use.typekit.com/cra4agv.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="wrapper">
          <h1 class="branding">
              <a href="http://engineyard.com/">Ruby On Rails Hosting Management: Engine Yard Platform-as-a-Service</a> <!-- CHANGE ON GO LIVE -->
          </h1>

          <ul class="utility">
            <li>866-518-YARD</li>
            <li>
              <form action="/search" method="get" class="search">
                <input type="text" name="q" id="searchbox" placeholder="search" />
                <input type="submit" value="Search" class="gsc-search-button" />
              </form>
            </li>
            <li>
			  <a href="https://login.engineyard.com/signup" class="login">Create Account</a>
            </li>
            <li>
			  <a href="https://cloud.engineyard.com" class="login">Sign In</a>
            </li>
          </ul>

          <nav> <!-- CHANGE ON GO LIVE -->
		  <ul class="navigation">
		    <li>
		      <a href="http://engineyard.com/products/appcloud"><span>Cloud Products</span></a>
		      <ul>
		        <li>
		          <a href="http://engineyard.com/products/appcloud">Engine Yard AppCloud</a>
		          <ul>
		            <li><a href="http://engineyard.com/products/appcloud/features">Features</a></li>
		            <li><a href="http://engineyard.com/products/appcloud/pricing">Pricing</a></li>
		            <li><a href="http://engineyard.com/video/17825326">Video Tour</a></li>
		          </ul>
		        </li>
		        <li>
		          <a href="http://engineyard.com/products/xcloud">Engine Yard xCloud</a>
		          <ul>
		            <li><a href="http://engineyard.com/products/xcloud/features">Features</a></li>
		            <li><a href="http://engineyard.com/products/xcloud/pricing">Pricing</a></li>
		          </ul>
		        </li>
		        <li>
		          <a href="http://engineyard.com/products/technology">Engine Yard Platform</a>
		          <ul>
		            <li><a href="http://engineyard.com/products/technology/stack">Technology Stack</a></li>
		          </ul>
		        </li>
		      </ul>
		    </li>

		    <li>
		      <a href="http://engineyard.com/support-plans"><span>Support</span></a>
		      <ul>
		        <li><a href="http://engineyard.com/support-plans">Support Plans</a></li>
		        <li><a href="http://engineyard.com/services">Professional Services</a></li>
		      </ul>
		    </li>

		    <li>
			  <a href="http://engineyard.com/university"><span>EY University</span></a>	
		    </li>

		    <li>
		      <a href="http://engineyard.com/videos"><span>Resources</span></a>
		      <ul>
		        <li><a href="http://engineyard.com/videos">Videos</a></li>
		        <li><a href="http://engineyard.com/podcasts">Podcasts</a></li>
		        <li><a href="http://engineyard.com/developer/events">Events</a></li>
		        <li><a href="http://engineyard.com/partners">Development Partners</a></li>
		        <li><a href="http://engineyard.com/developer/groups">User Groups</a></li> 
		        <li><a href="http://jobs.engineyard.com">Jobs Board</a></li>
		      </ul>
		    </li>

		    <li>
		      <a href="http://engineyard.com/open-source"><span>Open Source</span></a>
		      <ul>
		        <li><a href="http://engineyard.com/open-source">Projects</a></li>
		        <li><a href="http://engineyard.com/open-source/people">Contributors</a></li>
		      </ul>
		    </li>

		    <li>
		      <a href="http://engineyard.com/company/"><span>About</span></a>
		      <ul>
		        <li><a href="http://engineyard.com/company/">Overview</a></li>
		        <li><a href="http://engineyard.com/company/customers">Customers</a></li>
		        <li><a href="http://engineyard.com/company/team">Leadership Team</a></li>
		        <li><a href="http://engineyard.com/company/partners">Technology Partners</a></li>
		        <li><a href="http://engineyard.com/company/careers">Careers</a></li>
		        <li><a href="http://engineyard.com/company/news">News &amp; Press</a></li>
		        <li><a href="http://engineyard.com/company/contact">Contact Us</a></li>
		      </ul>
		    </li>

		    <li>
		      <a href="http://engineyard.com/blog"><span>Blog</span></a>
		    </li>
		  </ul>
		</nav>
        </div>
      </header>

      <div id="content">
        <div class="wrapper">
			<h1>Adding Cron Jobs</h1>

<p>Adding a scheduled task (cron job) to your environment can be done via your dashboard.
The task will be added to your application master instance under the crontab of either your deploy user or the root user (you choose which) and will only run on the application master by default. This avoids any potential adverse effects of a task accidentally running multiple times on different instances.</p>

<h2>Adding a new job</h2>

<p>To add a new cron job
{{:appcloud:guides:environments:moreoptions.png?400|'More Options' menu}}</p>

<ul><li>Click <strong>More Options</strong> then click on <strong>Crontabs</strong></li>
<li>You will then be presented with the <strong>Scheduled Jobs</strong> page</li>
</ul><p>{{:appcloud:guides:environments:scheduled-jobs.png?400|Scheduled Jobs page}}</p>

<ul><li>Give the job a name for reference</li>
<li>Enter the command to run (see notes on commands)</li>
<li>Choose which user's crontab to add this to</li>
<li>Define a schedule (if you are familiar with cron syntax, you may prefer to use the advanced interface)</li>
<li>Click <strong>Create</strong></li>
<li>Return to your dashboard and click the <strong>Please Rebuild</strong> or <strong>Deploy</strong> button as prompted</li>
</ul><h2>Notes about commands</h2>

<p>One of the most common uses for the crontab is to schedule the running of rake tasks or Rails runner scripts. When setting up such a task, you need to be aware of the following points:
  - rake tasks and runners need to be run from your application root
  - the cron environment does not have the same variables available as your standard shell (i.e.: RAILS_ENV will not be defined)</p>

<p>With that in mind, when adding such a task under cron, you will need to add your command like one of the examples below.</p>

<h3>Example rake task</h3>

<p><code>cd /data/appname/current &amp;&amp; RAILS_ENV=production rake some:task</code></p>

<h3>Example Rails runner task</h3>

<p><code>cd /data/appname/current &amp;&amp; ./script/runner -e production 'SomeClass.method'</code></p>

<p>or for Rails 3:</p>

<p><code>cd /data/appname/current &amp;&amp; rails runner -e production 'SomeClass.method'</code></p>

<h2>Advanced Usage</h2>

<h3>Running crons on different instances</h3>

<p>As mentioned at the start of this document, the default setup for scheduled jobs is to only configure them on the app master to avoid inadvertently running duplicate jobs. If you want to run cron jobs on other instances, then you need to create a <a href="appcloud/howtos/customizations/Custom%20Chef%20Recipes">custom chef recipe</a> to add the jobs to the crontabs of different instances.</p>

<p>A common requirement is to have cron jobs running on a utility instance, to achieve this you might write code like the following inside a cookbook recipe file:</p>

<p><code>
if node[:name] == 'instance_name'
  cron "task_name" do</code></p>

<pre><code>minute  '*/15'
user    'deploy'
command "cd /data/appname/current &amp;&amp; rails runner -e production 'SomeModel.some_method'"
</code></pre>

<p>  end
end

Above, <em>instance_name</em> would be the name you gave your utility instance when you created it. The <em>task_name</em> is just a label for the job. (similar to how you would give the job a name via the dashboard). Note that the <strong>minute</strong> method is using the cron syntax to specify 'every 15 minutes' - you can also specify 'hour' and 'day' within the code block.</p>

<h3>Lockrun</h3>

<p>Any frequently scheduled jobs can sometimes potentially run longer than their scheduled window allows. This can cause multiple runs of the same task to overlap. For example, if you have a rake task that runs every five minutes and one of these runs takes fifteen minutes to complete, cron will happily fire up another two runs of this task once their scheduled time comes round. This can cause various effects, dependent on what the task does, but most often causes spikes in server load and memory consumption. This problem tends to slow down the running of subsequent tasks, causing more overruns and compounding the issue.</p>

<p>To solve this common problem, we recommend the use of <a href="http://unixwiz.net/tools/lockrun.html">lockrun</a>. Lockrun is not installed by default so you will need to install it as outlined in the <a href="/appcloud/guides/applications/home#manage-unix-packages">manage UNIX packages</a> article.</p>

<p>Once you have lockrun installed on your instance(s), you can then use it in your cron jobs by writing the commands like this:</p>

<p><code>/usr/bin/lockrun --lockfile=/tmp/jobname.lockrun -- sh -c "cd /data/appname/current &amp;&amp; rake RAILS_ENV=production some:task"</code></p>

<h2>Troubleshooting cron issues =====</h2>

<p>==== Is cron running? ====
If you find that none of your cron jobs appear to be running, first check that cron is actually running with the following command:</p>

<p><code>/etc/init.d/vixie-cron status</code></p>

<p>If this command states that cron is not running, it may require restarting with this command:</p>

<p><code>/etc/init.d/vixie-cron restart</code></p>

<p>==== Are your scripts working? ====
If you can run the scripts successfully manually, but they fail when running under cron, you're going to need to see what output comes out of the command when run under cron.</p>

<p>By default, cron will try and send any output from jobs via email to the user that ran the job. As our instances do not have a mailserver running by default, the sending of these messages will fail and the output ends up in a <strong>dead.letter</strong> file. These files are located in the home directory of the user that ran the job. For example, you will find output of jobs run by root in <code>/root/dead.letter</code> (use <code>sudo</code> to read this file) and the output of jobs by your deploy user would be in <code>/home/deploy/dead.letter</code> (assuming <code>deploy</code> is the name of this user).</p>

<p>Note that dead.letter can contain output from multiple jobs and does not have any timestamps in place, so you may wish to modify the script that is being called by cron to output some extra information if you are trying to debug a problem. You can also delete this file and it will be recreated as necessary when new output is emailed from cron.</p>
		</div>
	</div>

      <div class="clear"></div> 

      <div id="footer">
        <div id="footer-content">
          <div class="page">
            <div class="grid_4">
              <p id="copyright">
                <p>   
                Running on Engine Yard: <a href="http://engineyard.com/products/appcloud">The Ruby Cloud</a> and <a href="http://github.com/github/gollum">Gollum</a><br /> <!-- CHANGE WHEN GO LIVE -->
                Ruby is the Language of the Cloud.<br />
                Copyright &copy; Engine Yard, Inc. All rights reserved.
              </p>
            </div>
            <div class="grid_2">
              <h2>Ruby Products</h2><!--CHANGE WHEN GO LIVE -->
              <ul>
                <li><a href="http://engineyard.com/products/appcloud">Engine Yard AppCloud</a></li>
                <li><a href="http://engineyard.com/products/xcloud">Engine Yard xCloud</a></li>
                <li><a href="http://engineyard.com/university/scheduled_classes">Rails 3 Training</a></li>
                <li><a href="http://engineyard.com/services">Professional Services</a></li>
              </ul>
            </div>
            <div class="grid_2">
              <h2>Customer Service</h2>  
              <ul>                       
                <li><a href="http://support.cloud.engineyard.com/">Request Support</a></li> 
                <li><a href="http://docs.engineyard.com">Documentation</a></li> 
                <li><a href="http://community.engineyard.com">Community Forums</a></li> 
                <li><a href="/products/support-policies">Support Policies</a></li>
                <li><a href="/legal/privacy">Privacy Policy</a></li>
              </ul>
            </div>
            <div class="grid_2">
              <h2>Ruby Community</h2>
              <ul>
                <li><a href="http://www.jruby.org">JRuby</a></li>
                <li><a href="http://rubini.us">Rubinius</a></li>
                <li><a href="http://www.railsinstaller.com">Rails Installer</a></li>
                <li><a href="http://jobs.engineyard.com">Ruby Jobs</a></li>
                <li><a href="http://www.railsdevelopment.com">Rails Developers</a></li>
              </ul>
            </div>
            <div class="grid_2">
              <h2>Socialize With Us</h2>
              <ul>
                <li>
					<a href="http://engineyard.com/blog" class="blog">Blog</a> <!--CHANGE WHEN LIVE-->
                </li>
                <li>
					<a href="http://twitter.com/engineyard" class="twitter trackLink">Twitter</a>
                </li>
                <li>                                                                             
					<a href="http://facebook.com/engineyard" class="facebook trackLink">Facebook</a>
                </li>
                <li>                                                                             
					<a href="http://www.linkedin.com/groups?gid=111752" class="linkedin trackLink">LinkedIn</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>           
    </div>

    <div class="hidden">
	  <script src="/javascripts/application.min.js"></script>
    </div>
  </body>
</html>