<!DOCTYPE HTML>
<html>
  <head>
  
    <title>Engine Yard Docs: How To Use Deploy Hooks with Engine Yard AppCloud</title>
    <meta name="description" content="Learn why Engine Yard\'s managed Rails hosting, Rails deployment &amp; 24/7/365 live service is the best">
    <meta name="keywords" content="Ruby on Rails Fully-Managed Hosting, Scaling, Scaled, Cluster Slices, Cloud Computing, On-Demand Deployment, Merb, Rubinius, Open-Source Software">
    <meta http-equiv="expires" content="0">

    <!--[if IE]>
	  <script src="/javascripts/html5shiv"></script>
    <![endif]-->
    
	<link rel="stylesheet" href="/css/application.css" type="text/css" charset="utf-8" />
    
    <!--[if IE]>
	  <link rel="stylesheet" href="/css/ie.css" type="text/css" charset="utf-8" />
    <![endif]-->
    
    <!--[if lte IE 7]>
	  <link rel="stylesheet" href="/css/ie7.css" type="text/css" charset="utf-8" />
    <![endif]-->

    <script src="http://use.typekit.com/cra4agv.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="wrapper">
          <h1 class="branding">
              <a href="http://engineyard.com/">Ruby On Rails Hosting Management: Engine Yard Platform-as-a-Service</a> <!-- CHANGE ON GO LIVE -->
          </h1>

          <ul class="utility">
            <li>866-518-YARD</li>
            <li>
              <form action="/search" method="get" class="search">
                <input type="text" name="q" id="searchbox" placeholder="search" />
                <input type="submit" value="Search" class="gsc-search-button" />
              </form>
            </li>
            <li>
			  <a href="https://login.engineyard.com/signup" class="login">Create Account</a>
            </li>
            <li>
			  <a href="https://cloud.engineyard.com" class="login">Sign In</a>
            </li>
          </ul>

          <nav> <!-- CHANGE ON GO LIVE -->
		  <ul class="navigation">
		    <li>
		      <a href="http://engineyard.com/products/appcloud"><span>Cloud Products</span></a>
		      <ul>
		        <li>
		          <a href="http://engineyard.com/products/appcloud">Engine Yard AppCloud</a>
		          <ul>
		            <li><a href="http://engineyard.com/products/appcloud/features">Features</a></li>
		            <li><a href="http://engineyard.com/products/appcloud/pricing">Pricing</a></li>
		            <li><a href="http://engineyard.com/video/17825326">Video Tour</a></li>
		          </ul>
		        </li>
		        <li>
		          <a href="http://engineyard.com/products/xcloud">Engine Yard xCloud</a>
		          <ul>
		            <li><a href="http://engineyard.com/products/xcloud/features">Features</a></li>
		            <li><a href="http://engineyard.com/products/xcloud/pricing">Pricing</a></li>
		          </ul>
		        </li>
		        <li>
		          <a href="http://engineyard.com/products/technology">Engine Yard Platform</a>
		          <ul>
		            <li><a href="http://engineyard.com/products/technology/stack">Technology Stack</a></li>
		          </ul>
		        </li>
		      </ul>
		    </li>

		    <li>
		      <a href="http://engineyard.com/support-plans"><span>Support</span></a>
		      <ul>
		        <li><a href="http://engineyard.com/support-plans">Support Plans</a></li>
		        <li><a href="http://engineyard.com/services">Professional Services</a></li>
		      </ul>
		    </li>

		    <li>
			  <a href="http://engineyard.com/university"><span>EY University</span></a>	
		    </li>

		    <li>
		      <a href="http://engineyard.com/videos"><span>Resources</span></a>
		      <ul>
		        <li><a href="http://engineyard.com/videos">Videos</a></li>
		        <li><a href="http://engineyard.com/podcasts">Podcasts</a></li>
		        <li><a href="http://engineyard.com/developer/events">Events</a></li>
		        <li><a href="http://engineyard.com/partners">Development Partners</a></li>
		        <li><a href="http://engineyard.com/developer/groups">User Groups</a></li> 
		        <li><a href="http://jobs.engineyard.com">Jobs Board</a></li>
		      </ul>
		    </li>

		    <li>
		      <a href="http://engineyard.com/open-source"><span>Open Source</span></a>
		      <ul>
		        <li><a href="http://engineyard.com/open-source">Projects</a></li>
		        <li><a href="http://engineyard.com/open-source/people">Contributors</a></li>
		      </ul>
		    </li>

		    <li>
		      <a href="http://engineyard.com/company/"><span>About</span></a>
		      <ul>
		        <li><a href="http://engineyard.com/company/">Overview</a></li>
		        <li><a href="http://engineyard.com/company/customers">Customers</a></li>
		        <li><a href="http://engineyard.com/company/team">Leadership Team</a></li>
		        <li><a href="http://engineyard.com/company/partners">Technology Partners</a></li>
		        <li><a href="http://engineyard.com/company/careers">Careers</a></li>
		        <li><a href="http://engineyard.com/company/news">News &amp; Press</a></li>
		        <li><a href="http://engineyard.com/company/contact">Contact Us</a></li>
		      </ul>
		    </li>

		    <li>
		      <a href="http://engineyard.com/blog"><span>Blog</span></a>
		    </li>
		  </ul>
		</nav>
        </div>
      </header>

      <div id="content">
        <div class="wrapper">
			<h1>How To Use Deploy Hooks with Engine Yard AppCloud</h1>

<p>Our deployment system mimics Capistrano's filesystem layout so it will be familiar to you if you have ever used Capistrano. In fact it is still backwards compatible with Capistrano so you can use both at the same time if so desired.</p>

<p>We also know that you may have some Capistrano hooks that you may need to emulate such as symlinking a shared/assets directory into the public directory on each deploy or symlinking certain config files. Our system supports these types of hooks in a slightly different way than Capistrano does.</p>

<p>To use the hooks, create an <code>APP_ROOT/deploy</code> directory in your app and place named hook files in there that will be triggered at the appropriate times during the deploy. The hooks are defined as follows:</p>

<pre><code>APP_ROOT/
  deploy/
    before_migrate.rb
    before_symlink.rb
    before_restart.rb
    after_restart.rb
</code></pre>

<p>Remember that, in order for migrations to run, your entire environment will be loaded. So if you have any symlinks that need to be created in order for the application to start properly you will want to put them in <code>before_migrate.rb</code> instead of <code>before_symlink.rb</code>, since <code>before_symlink.rb</code> runs <strong>after</strong> the migration. These scripts will be instance_eval'd in the context of the chef-deploy resource. This means that you will have certain commands and variables available to you in these hooks. For example:</p>

<pre><code>run "echo 'release_path: #{release_path}' &gt;&gt; #{shared_path}/logs.log"
run "ln -nfs #{shared_path}/config/foo.yml #{release_path}/config/foo.yml"
sudo "echo 'sudo works' &gt;&gt; /root/sudo.log"
</code></pre>

<p>You have access to a <code>run</code> command and a <code>sudo</code> command. Both of these will run shell commands: <code>run</code> will run as your normal Unix user that the app is deployed as and <code>sudo</code> will run as root for when you need more permissions.</p>

<h3>Call Git Commands</h3>

<p>Here's an example where you can call a git command from a deploy hook:</p>

<pre><code>run "exec ssh-agent bash -c 'ssh-add /home/deploy/.ssh/&lt;app&gt;-deploy-key &amp;&amp; git clone git@github.com:foo/bar.git #{current_path}/tmp/foo'"
</code></pre>

<p>Replace <code>&lt;app&gt;</code> with the name of your app and change the path for your git repo.</p>

<h3>Deploy Hook Variables</h3>

<p>You will have some of the same variables you are used to from Capistrano:</p>

<p><strong>release_path</strong>: this is the full path to the current release: e.g. <code>/data/appname/releases/12345678</code></p>

<p><strong>shared_path</strong>: this is the path to the shared dir: e.g. <code>/data/appname/shared</code></p>

<p><strong>current_path</strong>: this is the path to the currently symlinked release: e.g. <code>/data/appname/current</code></p>

<p><strong>node</strong>:  node is the full hash object of all the info we know about your applications and deployments.</p>

<p>Here is an example JSON document that shows you what kind of info is inside the <strong>node</strong> object:</p>

<pre><code>{
  "aws_secret_key": "xxxxxxxxxxxxxxxxxxxx",
  "backup_interval": 24,
  "admin_ssh_key": "ssh-rsa xxxxxxx== awsm@engineyard.com",
  "user_ssh_key": [

  ],
  "mailserver": "smtp.engineyard.com",
  "instance_role": "solo",
  "crons": [

  ],
  "removed_applications": [

  ],
  "backup_window": 1,
  "gems_to_install": [
    {
      "name": "rails",
      "version": "2.3.2"
    }
  ],
  "alert_email": "foo@bar.com",
  "applications": {
    "railsapp": {
      "auth": {
        "active": false
      },
      "type": "rails",
      "https_bind_port": 443,
      "repository_name": "git:\/\/github.com\/engineyard\/rails-2.2.2-app.git",
      "migration_command": "rake db:migrate",
      "http_bind_port": 80,
      "run_deploy": true,
      "revision": "",
      "branch": "HEAD",
      "deploy_key": "-----BEGIN RSA PRIVATE KEY-----\nxxxx\n-----END RSA PRIVATE KEY-----\n",
      "run_migrations": true,
      "deploy_action": "deploy",
      "services": [
        {
          "resource": "mongrel",
          "mongrel_base_port": 5000,
          "mongrel_mem_limit": 150,
          "mongrel_instance_count": 3
        },
        {
          "resource": "memcached",
          "base_port": 11211,
          "mem_limit": 128
        }
      ],
      "recipes": [
        "memcached",
        "monit",
        "nginx",
        "nginx-passenger"
      ],
      "vhosts": [
        {
          "name": "foo.com",
          "role": "velocity"
        }
      ]
    }
  },
  "reporting_url": "https:\/\/cloud.engineyard.com\/reporting\/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "aws_secret_id": "xxxxxxxxxxxxxx",
  "environment": {
    "name": "myenvironment",
    "framework_env": "production"
  },
  "users": [
    {
      "gid": "1000",
      "username": "ez",
      "uid": "1000",
      "comment": "",
      "password": "xxxxxxxxxxxx"
    }
  ],
  "packages_to_install": [

  ]
}
</code></pre>
		</div>
	</div>

      <div class="clear"></div> 

      <div id="footer">
        <div id="footer-content">
          <div class="page">
            <div class="grid_4">
              <p id="copyright">
                <p>   
                Running on Engine Yard: <a href="http://engineyard.com/products/appcloud">The Ruby Cloud</a> and <a href="http://github.com/github/gollum">Gollum</a><br /> <!-- CHANGE WHEN GO LIVE -->
                Ruby is the Language of the Cloud.<br />
                Copyright &copy; Engine Yard, Inc. All rights reserved.
              </p>
            </div>
            <div class="grid_2">
              <h2>Ruby Products</h2><!--CHANGE WHEN GO LIVE -->
              <ul>
                <li><a href="http://engineyard.com/products/appcloud">Engine Yard AppCloud</a></li>
                <li><a href="http://engineyard.com/products/xcloud">Engine Yard xCloud</a></li>
                <li><a href="http://engineyard.com/university/scheduled_classes">Rails 3 Training</a></li>
                <li><a href="http://engineyard.com/services">Professional Services</a></li>
              </ul>
            </div>
            <div class="grid_2">
              <h2>Customer Service</h2>  
              <ul>                       
                <li><a href="http://support.cloud.engineyard.com/">Request Support</a></li> 
                <li><a href="http://docs.engineyard.com">Documentation</a></li> 
                <li><a href="http://community.engineyard.com">Community Forums</a></li> 
                <li><a href="/products/support-policies">Support Policies</a></li>
                <li><a href="/legal/privacy">Privacy Policy</a></li>
              </ul>
            </div>
            <div class="grid_2">
              <h2>Ruby Community</h2>
              <ul>
                <li><a href="http://www.jruby.org">JRuby</a></li>
                <li><a href="http://rubini.us">Rubinius</a></li>
                <li><a href="http://www.railsinstaller.com">Rails Installer</a></li>
                <li><a href="http://jobs.engineyard.com">Ruby Jobs</a></li>
                <li><a href="http://www.railsdevelopment.com">Rails Developers</a></li>
              </ul>
            </div>
            <div class="grid_2">
              <h2>Socialize With Us</h2>
              <ul>
                <li>
					<a href="http://engineyard.com/blog" class="blog">Blog</a> <!--CHANGE WHEN LIVE-->
                </li>
                <li>
					<a href="http://twitter.com/engineyard" class="twitter trackLink">Twitter</a>
                </li>
                <li>                                                                             
					<a href="http://facebook.com/engineyard" class="facebook trackLink">Facebook</a>
                </li>
                <li>                                                                             
					<a href="http://www.linkedin.com/groups?gid=111752" class="linkedin trackLink">LinkedIn</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>           
    </div>

    <div class="hidden">
	  <script src="/javascripts/application.min.js"></script>
    </div>
  </body>
</html>