<h1>Load Testing your AppCloud Environment using em-proxy</h1>

<p>With <a href="http://github.com/igrigorik/em-proxy">em-proxy</a>, a proxy built with <a href="http://rubyeventmachine.com/">eventmachine</a>, you can send some real traffic to your Engine Yard AppCloud environment for load testing.  This allows you to test your application's performance prior to migrating giving you peace of mind that things will perform great once you do migrate. It will also allow you to compare your <a href="http://rpm.newrelic.com">New Relic</a> stats and make any needed adjustments.</p>

<p><strong><em>WARNING: Since you will be sending real traffic to Engine Yard AppCloud using this technique you need to be absolutely sure to disable things like email and billing in your application while you test.  You do not want to be double billing or spamming your users.</em></strong></p>

<p><a href="http://thoughtbot.com">Thoughbot</a> did a great blogpost on their experience <a href="http://robots.thoughtbot.com/post/486653439/hopping-in-the-cloud">using this benchmarking technique</a>.  Additionally you can read <a href="http://www.igvita.com/2009/04/20/ruby-proxies-for-scale-and-monitoring">Igvita's post</a> on the topic as well.</p>

<p>Using this example configuration, requests returning from Engine Yard AppCloud will be dropped at the proxy. This will make your testing completely transparent to your end users.</p>

<h2>Configuration and Installation</h2>

<p>You perform the proxy setup and configuration on your current production servers.  It resides between your load balancer and your web server.  As a few adjustments will need to be made, we'll describe those in detail in a moment.</p>

<h4>Install The Gem and Create Your Config File</h4>

<p><code>
 sudo gem install em-proxy --no-ri --no-rdoc
</code></p>

<p>Create a <code>proxy.rb</code> file to the root users home directory.</p>

<h4>Update Nginx</h4>

<p>Since em-proxy will be running on port <code>80</code>, nginx will have to run on port <code>8080</code>.  Change your nginx vhost listening on port <code>80</code> to port <code>8080</code>, then restart nginx using <code>/etc/init.d/nginx restart</code> command.</p>

<h4>Start The Proxy</h4>

<p>Start the proxy up on one server at a time, if you run into issues along the way it will be much easier to back out any changes.</p>

<p>Run the <code>proxy.rb</code> inside of a screen session.</p>

<p><code>
$ screen
$ ruby proxy.rb
</code></p>

<p>To detach from the screen session simply hit <code>ctrl+a+d</code> and you will detach.</p>

<p>To later resume the screen session:
<code>
$screen -x
</code></p>

<p>The proxy will start up and start taking traffic on port <code>80</code>. It will proxy traffic to nginx, locally, on port <code>8080</code>.</p>

<h4>Test The Setup</h4>

<p>Make sure you can curl your app and receive the response you expect.</p>

<p><code>
$ curl -H host:yourhostname.com http://localhost
</code></p>

<h2>Disabling The Proxy</h2>

<p>To turn the proxy off:</p>

<ul><li>First kill the ruby process you fired up.</li>
<li>Next revert the nginx config changes so that your vhosts are listening on port <code>80</code> instead of port <code>8080</code>.</li>
<li>Then restart nginx using the command: <code>/etc/init.d/nginx restart</code></li>
</ul><p>Now you are back to your default configuration.</p>

<h2>Example Code</h2>

<p>An example of <code>proxy.rb</code>:
<code>
<code>#</code> proxy.rb
require 'em-proxy'</code></p>

<p>Proxy.start(:host =&gt; "0.0.0.0", :port =&gt; 80) do |conn|
  conn.server :production, :host =&gt; '127.0.0.1', :port =&gt; 8080
  conn.server :ey_cloud, :host =&gt; '192.0.32.10', :port =&gt; 80
  conn.on_data do |data|</p>

<pre><code>data
</code></pre>

<p>  end
  conn.on_response do |server, resp|</p>

<pre><code>resp if server == :production
</code></pre>

<p>  end
end
</p>

<p>Let's step through this script and describe what it does.</p>

<p>This starts the proxy up on port <code>80</code>, and listens for any incoming requests.</p>

<p><code>
Proxy.start(:host =&gt; "0.0.0.0", :port =&gt; 80) do |conn|
</code></p>

<p>This proxies the traffic to the servers you define. Your production server proxies locally to nginx and listens on port <code>8080</code>.</p>

<p><strong>NOTE</strong>: Replace <code>192.0.32.10</code> with the IP of your EY AppCloud environment.</p>

<p><code>
conn.server :production, :host =&gt; '127.0.0.1', :port =&gt; 8080
conn.server :ey_cloud, :host =&gt; '192.0.32.10', :port =&gt; 80
</code></p>

<p>This sends the response back to the user if the traffic came from the production server.</p>

<p><code>
 conn.on_response do |server, resp|
   resp if server == :production
 end
</code></p>